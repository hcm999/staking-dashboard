<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GANA质押管理平台</title>
    <!-- 引入 Bootstrap 用于快速布局 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入 Ethers.js V6 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { background-color: #1e293b; border: 1px solid #334155; }
        .card-title { color: #fff; }
        .btn-primary { background-color: #3b82f6; border: none; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-success { background-color: #10b981; border: none; }
        .btn-danger { background-color: #ef4444; border: none; }
        .btn-warning { background-color: #f59e0b; border: none; color: #fff; }
        .btn-warning:hover { background-color: #d97706; color: #fff; }
        .warning-box {
            background-color: #450a0a;
            border: 1px solid #ef4444;
            color: #fca5a5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        .stat-value { font-size: 1.25rem; font-weight: bold; color: #38bdf8; }
        .stat-label { font-size: 0.85rem; color: #94a3b8; }
        .table { color: #cbd5e1; font-size: 0.9rem; }
        .table thead th { border-bottom: 1px solid #475569; color: #94a3b8; font-size: 0.8rem; }
        .table td { border-bottom: 1px solid #334155; vertical-align: middle; }
        input.form-control { background-color: #334155; border-color: #475569; color: white; }
        input.form-control:focus { background-color: #334155; color: white; border-color: #38bdf8; box-shadow: none; }
        .staking-btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .staking-btn-group .btn { flex: 1; min-width: 120px; }
        .badge-duration { background-color: #374151; color: #9ca3af; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem; }
        .countdown { 
            font-family: 'Courier New', monospace; 
            background-color: #1f2937; 
            padding: 2px 6px; 
            border-radius: 3px; 
            font-size: 0.75rem;
            display: inline-block;
        }
        .countdown-locked { color: #f87171; }
        .countdown-unlocked { color: #34d399; }
        .align-items-end label.form-label { color: wheat; }
        
        /* 调整表格中特定列的字体大小 */
        .stake-time-cell { font-size: 0.8rem; }
        .remaining-time-cell { font-size: 0.8rem; }
        .status-cell { font-size: 0.8rem; }
        .action-cell { font-size: 0.8rem; }
        
        /* 调整ID和金额列的字体大小 */
        .table td:first-child { font-size: 0.85rem; } /* ID列 */
        .table td:nth-child(2) { font-size: 0.85rem; } /* 金额列 */
        
        /* 调整表格行高 */
        .table tbody tr { height: 40px; }
        
        /* 调整操作按钮大小 */
        .action-cell .btn-sm { 
            padding: 0.15rem 0.4rem; 
            font-size: 0.75rem; 
            line-height: 1.2;
        }
        
        /* 新添加的样式 */
        .nav-tabs { border-bottom: 1px solid #334155; }
        .nav-tabs .nav-link { 
            color: #94a3b8; 
            border: 1px solid transparent;
            border-radius: 0.375rem 0.375rem 0 0;
        }
        .nav-tabs .nav-link:hover { 
            color: #cbd5e1; 
            border-color: #475569;
        }
        .nav-tabs .nav-link.active { 
            color: #38bdf8; 
            background-color: #1e293b; 
            border-color: #475569 #475569 #1e293b;
        }
        .tab-content { padding-top: 1rem; }
        .address-short { 
            font-family: 'Courier New', monospace; 
            background-color: #1f2937; 
            padding: 2px 6px; 
            border-radius: 3px; 
            font-size: 0.8rem;
        }
        .total-stats-card { border-left: 4px solid #3b82f6; }
        .contract-address { 
            font-family: 'Courier New', monospace; /* 设置字体为等宽字体 */
            font-size: 0.9rem; /* 字体大小：0.8rem（约12.8px） */
            font-weight: 500; /* 加粗 */
            color: #60a5fa; /* 亮蓝色文字 */
            word-break: break-all; /* 长地址自动换行 */
            background-color: #1f2937; /* 背景颜色：深灰色 */
            padding: 5px 10px; /* 内边距 */
            border-radius: 5px; /* 圆角 */
            margin: 5px 0; /* 外边距 */
        }
    </style>
</head>
<body>

    <!-- 合约地址信息 -->
    <div class="alert alert-info mb-4">
        <h6 class="fw-bold">合约地址信息</h6>
        <div class="row">
            <div class="col-md-6">
                <div class="mb-2">
                    <small class="text-muted">质押合约：</small>
                    <div class="contract-address" id="stakingContractAddress">0x72212F35aC448FE7763aA1BFdb360193Fa098E52</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-2">
                    <small class="text-muted">LP池合约：</small>
                    <div class="contract-address" id="lpContractAddress">0xa2f464a2462aed49b9b31eb8861bc6b0bbb0483f</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 钱包连接 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold">GANA质押管理平台</h3>
        <button id="connectBtn" class="btn btn-primary" onclick="connectWallet()">连接钱包</button>
    </div>

    <!-- 数据统计面板 -->
    <div class="row mb-4 text-center g-2">
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100">
                <div class="stat-label">我的 USDT 余额</div>
                <div class="stat-value" id="myBalance">0.0000</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100">
                <div class="stat-label">待提现余额 (合约内)</div>
                <div class="stat-value" id="stakedBalance">0.0000</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100">
                <div class="stat-label">可提现 USDT (池子)</div>
                <div class="stat-value" id="poolBalance">0.0000</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100">
                <div class="stat-label">合约总质押</div>
                <div class="stat-value" id="totalStaked">0.0000</div>
            </div>
        </div>
    </div>

    <!-- 质押操作区域 -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">参与质押</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-6">
                    <label class="form-label">质押金额 (USDT)</label>
                    <input type="number" class="form-control" id="stakeAmount" value="1000" placeholder="输入金额">
                </div>
                <div class="col-md-6">
                    <label class="form-label d-block">选择质押周期</label>
                    <div class="staking-btn-group">
                        <button class="btn btn-success" onclick="handleStake(0, 1)">1天(0.4%)</button>
                        <button class="btn btn-success" onclick="handleStake(1, 15)">15天(0.8%)</button>
                        <button class="btn btn-success" onclick="handleStake(2, 30)">30天(1.3%)</button>
                    </div>
                </div>
            </div>
            <div class="mt-2 small text-white">
                * 注意：不同质押周期的日化率和解锁时间不同
            </div>
        </div>
    </div>

    <!-- 质押记录区域（选项卡） -->
    <div class="card">
        <div class="card-body">
            <!-- 选项卡导航 -->
            <ul class="nav nav-tabs" id="stakeTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="my-stake-tab" data-bs-toggle="tab" data-bs-target="#my-stake" type="button" role="tab" aria-controls="my-stake" aria-selected="true">我的质押记录</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="all-stake-tab" data-bs-toggle="tab" data-bs-target="#all-stake" type="button" role="tab" aria-controls="all-stake" aria-selected="false">合约总质押记录</button>
                </li>
            </ul>
            
            <!-- 选项卡内容 -->
            <div class="tab-content" id="stakeTabContent">
                <!-- 我的质押记录 -->
                <div class="tab-pane fade show active" id="my-stake" role="tabpanel" aria-labelledby="my-stake-tab">
                    <div class="d-flex justify-content-between align-items-center mb-3 mt-3">
                        <h5 class="card-title mb-0">我的质押记录</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-light" onclick="refreshData()">刷新数据</button>
                            <button class="btn btn-sm btn-outline-info ms-2" onclick="toggleAutoRefresh()" id="autoRefreshBtn">自动刷新: 关闭</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>金额 (USDT)</th>
                                    <th>质押周期</th>
                                    <th>质押时间</th>
                                    <th>剩余时间</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="stakeListBody">
                                <tr><td colspan="7" class="text-center">请连接钱包查看数据</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 合约总质押记录 -->
                <div class="tab-pane fade" id="all-stake" role="tabpanel" aria-labelledby="all-stake-tab">
                    <div class="d-flex justify-content-between align-items-center mb-3 mt-3">
                        <h5 class="card-title mb-0">合约总质押记录</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-light" onclick="refreshAllStakeData()">刷新总质押</button>
                        </div>
                    </div>
                    
                    <!-- 总质押统计 -->
                    <div class="row mb-4 text-center g-2">
                        <div class="col-6 col-md-3">
                            <div class="card p-3 h-100">
                                <div class="stat-label">总质押用户数</div>
                                <div class="stat-value" id="totalUsers">0</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card p-3 h-100">
                                <div class="stat-label">活跃质押数量</div>
                                <div class="stat-value" id="activeStakes">0</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card p-3 h-100">
                                <div class="stat-label">平均质押金额</div>
                                <div class="stat-value" id="avgStakeAmount">0.0000</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card p-3 h-100">
                                <div class="stat-label">总质押次数</div>
                                <div class="stat-value" id="totalStakeCount">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 总质押列表 -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>序号</th>
                                    <th>用户地址</th>
                                    <th>金额 (USDT)</th>
                                    <th>质押周期</th>
                                    <th>质押时间</th>
                                    <th>状态</th>
                                </tr>
                            </thead>
                            <tbody id="allStakeListBody">
                                <tr><td colspan="6" class="text-center">点击"刷新总质押"查看合约总质押记录</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 分页控件 -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="text-white small">
                            显示 <span id="currentPage">1</span> / <span id="totalPages">1</span> 页
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-light" onclick="prevPage()" id="prevPageBtn" disabled>上一页</button>
                            <button class="btn btn-sm btn-outline-light ms-2" onclick="nextPage()" id="nextPageBtn" disabled>下一页</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 引入 Bootstrap JS 用于选项卡功能 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ================= 配置区域 =================
    const CONFIG = {
        STAKING: "0x72212F35aC448FE7763aA1BFdb360193Fa098E52", // 新质押合约地址
        USDT: "0x55d398326f99059fF775485246999027B3197955",   // BSC链上的USDT
        PAIR: "0xa2f464a2462aed49b9b31eb8861bc6b0bbb0483f",   // 新LP池地址
        
        // 总质押记录相关配置
        TOTAL_STAKE_PAGE_SIZE: 10,  // 每页显示记录数
        SAMPLE_USER_ADDRESSES: [  // 示例用户地址列表
            "0x1234567890123456789012345678901234567890",
            "0x2345678901234567890123456789012345678901",
            "0x3456789012345678901234567890123456789012",
            "0x4567890123456789012345678901234567890123",
            "0x5678901234567890123456789012345678901234"
        ]
    };
    
    // 质押周期配置 (秒)
    const STAKE_DURATIONS = {
        0: 86400,      // 1天
        1: 1296000,    // 15天 (15 * 86400)
        2: 2592000     // 30天 (30 * 86400)
    };
    
    const STAKE_DURATION_LABELS = {
        0: "1天",
        1: "15天", 
        2: "30天"
    };
    // ===========================================

    // ABIs - 使用您提供的新ABI
    const ABI_ERC20 = [
        "function balanceOf(address owner) view returns (uint256)",
        "function decimals() view returns (uint8)",
        "function approve(address spender, uint256 amount) returns (bool)",
        "function allowance(address owner, address spender) view returns (uint256)"
    ];

    const ABI_STAKING = [
        // 构造函数和错误
        {"inputs":[{"internalType":"address","name":"marketingAddress_","type":"address"},{"internalType":"address","name":"devAddress_","type":"address"},{"internalType":"address","name":"threesevenAddress_","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
        {"inputs":[{"internalType":"uint256","name":"x","type":"uint256"},{"internalType":"uint256","name":"y","type":"uint256"}],"name":"PRBMath_MulDiv18_Overflow","type":"error"},
        {"inputs":[{"internalType":"uint256","name":"x","type":"uint256"},{"internalType":"uint256","name":"y","type":"uint256"},{"internalType":"uint256","name":"denominator","type":"uint256"}],"name":"PRBMath_MulDiv_Overflow","type":"error"},
        
        // 事件
        {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},
        {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"reward","type":"uint256"},{"indexed":false,"internalType":"uint40","name":"timestamp","type":"uint40"},{"indexed":false,"internalType":"uint256","name":"index","type":"uint256"}],"name":"RewardPaid","type":"event"},
        {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"index","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"stakeTime","type":"uint256"}],"name":"Staked","type":"event"},
        {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Transfer","type":"event"},
        
        // 视图函数
        {"inputs":[],"name":"GANA","outputs":[{"internalType":"contract IGANA","name":"","type":"address"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"MIN_STAKE_USDT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"back_Fee","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"balance","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"devAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"isPreacher","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"market_Fee","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"marketingAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"maxStakeAmount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"network1In","outputs":[{"internalType":"uint256","name":"value","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint8","name":"index","type":"uint8"}],"name":"principalPlusRewardOfSlot","outputs":[{"internalType":"uint256","name":"reward","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"ratePerSec","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"stakeCount","outputs":[{"internalType":"uint256","name":"count","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"t_supply","outputs":[{"internalType":"uint40","name":"stakeTime","type":"uint40"},{"internalType":"uint160","name":"tamount","type":"uint160"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"threesevenAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"threeseven_Fee","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userStakeRecord","outputs":[{"internalType":"uint40","name":"stakeTime","type":"uint40"},{"internalType":"uint160","name":"amount","type":"uint160"},{"internalType":"bool","name":"status","type":"bool"},{"internalType":"uint8","name":"stakeIndex","type":"uint8"}],"stateMutability":"view","type":"function"},
        
        // 交易函数
        {"inputs":[{"internalType":"address","name":"_gana","type":"address"}],"name":"setGANA","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"uint160","name":"_amount","type":"uint160"},{"internalType":"uint256","name":"amountOutMin","type":"uint256"},{"internalType":"uint8","name":"_stakeIndex","type":"uint8"}],"name":"stake","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[],"name":"sync","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"unstake","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"}
    ];

    // 全局变量
    let provider, signer, userAddress;
    let stakingContract, usdtContract;
    let autoRefreshInterval = null;
    let countdownTimers = {};
    
    // 总质押记录相关变量
    let allStakeData = [];  // 存储所有质押记录
    let currentPage = 1;    // 当前页码
    let totalPages = 1;     // 总页数

    // 工具：格式化金额为4位小数
    function formatAmount(wei) {
        try {
            const val = ethers.formatUnits(wei, 18);
            return parseFloat(val).toFixed(0);
        } catch (e) {
            return "0";
        }
    }

    // 格式化金额为2位小数
    function formatAmountTwoDecimals(wei) {
        try {
            const val = ethers.formatUnits(wei, 18);
            return parseFloat(val).toFixed(2);
        } catch (e) {
            return "0.00";
        }
    }

    // 格式化时间：将秒转换为天、小时、分钟
    function formatTimeRemaining(seconds) {
        if (seconds <= 0) return "0秒";
        
        const days = Math.floor(seconds / 86400);
        const hours = Math.floor((seconds % 86400) / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        let result = "";
        if (days > 0) result += `${days}天`;
        if (hours > 0) result += `${hours}小时`;
        if (minutes > 0 && days === 0) result += `${minutes}分`;
        if (secs > 0 && days === 0 && hours === 0) result += `${secs}秒`;
        
        return result || "0秒";
    }
    
    // 格式化质押时间：显示更简洁的时间格式
    function formatStakeTime(timestamp) {
        try {
            const date = new Date(timestamp * 1000);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            // 如果是今天
            if (diffDays === 0) {
                return '今天 ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', sec: '2-digit' });
            } 
            // 如果是昨天
            else if (diffDays === 1) {
                return '昨天 ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', sec: '2-digit' });
            }
            // 如果是更早的时间
            else {
                return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' }) + ' ' + 
                       date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', sec: '2-digit' });
            }
        } catch (e) {
            return "时间错误";
        }
    }
    
    // 缩短地址显示
    function shortenAddress(address) {
        if (!address) return '';
        return address.substring(0, 6) + '...' + address.substring(address.length - 4);
    }

    // 1. 连接钱包
    async function connectWallet() {
        if (!window.ethereum) {
            alert("请安装 MetaMask!");
            return;
        }
        try {
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            userAddress = await signer.getAddress();
            
            // 更新UI
            document.getElementById('connectBtn').innerText = userAddress.slice(0, 6) + "..." + userAddress.slice(-4);
            document.getElementById('connectBtn').classList.replace('btn-primary', 'btn-success');

            // 初始化合约
            stakingContract = new ethers.Contract(CONFIG.STAKING, ABI_STAKING, signer);
            usdtContract = new ethers.Contract(CONFIG.USDT, ABI_ERC20, signer);

            // 加载数据
            await refreshData();
            
            // 显示提示信息
            alert("钱包连接成功！\n合约地址：" + CONFIG.STAKING);
        } catch (error) {
            console.error("连接失败:", error);
            alert("连接钱包失败: " + (error.message || error));
        }
    }

    // 2. 刷新所有数据
    async function refreshData() {
        if (!userAddress) return;
        const btn = document.querySelector('button[onclick="refreshData()"]');
        const originalText = btn.innerText;
        btn.innerText = "加载中...";
        
        try {
            // 2.1 获取我的 USDT 余额
            const myBal = await usdtContract.balanceOf(userAddress);
            document.getElementById('myBalance').innerText = formatAmountTwoDecimals(myBal);

            // 2.2 获取待提现余额 (合约内的 balanceOf)
            const stakedBal = await stakingContract.balanceOf(userAddress);
            document.getElementById('stakedBalance').innerText = formatAmountTwoDecimals(stakedBal);

            // 2.3 获取可提现余额 (池子里的 USDT)
            const poolBal = await usdtContract.balanceOf(CONFIG.PAIR);
            document.getElementById('poolBalance').innerText = formatAmountTwoDecimals(poolBal);
            
            // 2.4 获取合约总质押金额
            const totalStaked = await stakingContract.totalSupply();
            document.getElementById('totalStaked').innerText = formatAmountTwoDecimals(totalStaked);

            // 2.5 获取质押列表
            await renderStakeList();
            btn.innerText = "刷新";
        } catch (error) {
            console.error("数据加载错误:", error);
            document.getElementById('myBalance').innerText = "加载失败";
            document.getElementById('stakedBalance').innerText = "加载失败";
            document.getElementById('poolBalance').innerText = "加载失败";
            document.getElementById('totalStaked').innerText = "加载失败";
        } finally {
            btn.innerText = originalText;
        }
    }

    // 3. 渲染质押列表
    async function renderStakeList() {
        const tbody = document.getElementById('stakeListBody');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">加载中...</td></tr>';

        try {
            const count = await stakingContract.stakeCount(userAddress);
            let html = '';
            
            const now = Math.floor(Date.now() / 1000);

            // 清空旧的倒计时定时器
            Object.keys(countdownTimers).forEach(id => {
                clearInterval(countdownTimers[id]);
                delete countdownTimers[id];
            });

            // 倒序显示
            for (let i = Number(count) - 1; i >= 0; i--) {
                try {
                    const record = await stakingContract.userStakeRecord(userAddress, i);
                    
                    const amount = formatAmountTwoDecimals(record[1]); 
                    const stakeTime = Number(record[0]);
                    const stakeTimeStr = formatStakeTime(stakeTime);
                    const isActive = record[2]; 
                    const stakeIndex = Number(record[3]);
                    const durationSeconds = STAKE_DURATIONS[stakeIndex] || 86400;
                    
                    // 计算解锁时间
                    const unlockTime = stakeTime + durationSeconds;
                    const timeRemaining = unlockTime - now;
                    
                    // 计算是否锁定
                    const isLocked = timeRemaining > 0 && !isActive;
                    const isUnlocked = timeRemaining <= 0 && !isActive;
                    
                    let statusHtml = '';
                    let actionHtml = '';
                    let timeRemainingHtml = '';
                    let durationLabel = STAKE_DURATION_LABELS[stakeIndex] || "未知";

                    if (isActive) {
                        statusHtml = '<span class="text-muted">已提取</span>';
                        actionHtml = '-';
                        timeRemainingHtml = '<span class="text-muted">-</span>';
                    } else {
                        if (isLocked) {
                            // 锁仓中
                            statusHtml = '<span class="text-danger">正在锁仓</span>';
                            actionHtml = `<button class="btn btn-sm btn-secondary" disabled>等待解锁</button>`;
                            
                            // 创建倒计时显示元素
                            timeRemainingHtml = `<span class="countdown countdown-locked" id="countdown-${i}">${formatTimeRemaining(timeRemaining)}</span>`;
                            
                            // 启动倒计时定时器
                            startCountdown(i, timeRemaining);
                        } else if (isUnlocked) {
                            // 可赎回
                            statusHtml = '<span class="text-success">可以赎回</span>';
                            actionHtml = `<button class="btn btn-sm btn-warning" id="unstake-btn-${i}" onclick="handleUnstake(${i})">立即赎回</button>`;
                            timeRemainingHtml = '<span class="countdown countdown-unlocked">已解锁</span>';
                        } else {
                            statusHtml = '<span class="text-warning">未知</span>';
                            actionHtml = '-';
                            timeRemainingHtml = '-';
                        }
                    }

                    html += `
                        <tr>
                            <td>${i}</td>
                            <td>${amount}</td>
                            <td><span class="badge-duration">${durationLabel}</span></td>
                            <td class="stake-time-cell">${stakeTimeStr}</td>
                            <td class="remaining-time-cell">${timeRemainingHtml}</td>
                            <td class="status-cell">${statusHtml}</td>
                            <td class="action-cell">${actionHtml}</td>
                        </tr>
                    `;
                } catch (recordError) {
                    console.error(`获取记录 ${i} 失败:`, recordError);
                }
            }

            if (Number(count) === 0) {
                html = '<tr><td colspan="7" class="text-center">暂无质押记录</td></tr>';
            }

            tbody.innerHTML = html;
        } catch (error) {
            console.error("列表加载失败:", error);
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">列表加载失败</td></tr>';
        }
    }

    // 启动倒计时定时器
    function startCountdown(id, initialSeconds) {
        let remaining = initialSeconds;
        const countdownElement = document.getElementById(`countdown-${id}`);
        
        if (!countdownElement) return;
        
        const timer = setInterval(() => {
            remaining--;
            
            if (remaining <= 0) {
                clearInterval(timer);
                // 刷新整个列表
                refreshData();
                return;
            }
            
            if (countdownElement) {
                countdownElement.textContent = formatTimeRemaining(remaining);
                
                // 更新倒计时颜色
                if (remaining <= 3600) { // 小于1小时
                    countdownElement.style.color = '#f87171'; // 红色
                } else if (remaining <= 86400) { // 小于1天
                    countdownElement.style.color = '#fbbf24'; // 黄色
                } else {
                    countdownElement.style.color = '#60a5fa'; // 蓝色
                }
            }
        }, 1000);
        
        countdownTimers[id] = timer;
    }

    // 4. 质押逻辑
    async function handleStake(stakeIndex, durationDays) {
        if (!userAddress) return alert("请先连接钱包");
        
        const amountStr = document.getElementById('stakeAmount').value;
        if (!amountStr || parseFloat(amountStr) <= 0) return alert("请输入有效金额");
        
        const amountWei = ethers.parseUnits(amountStr, 18);
        
        // 获取所有质押按钮
        const buttons = document.querySelectorAll('.staking-btn-group .btn');
        const originalTexts = [];
        
        try {
            // 禁用所有质押按钮并保存原始文本
            buttons.forEach(btn => {
                originalTexts.push(btn.textContent);
                btn.disabled = true;
            });
            
            // 设置当前按钮的文本
            const currentBtn = event.target;
            currentBtn.textContent = "检查限额...";

            // 0. 检查最小质押金额
            try {
                const minStake = await stakingContract.MIN_STAKE_USDT();
                const minStakeAmount = parseFloat(ethers.formatUnits(minStake, 18));
                if (parseFloat(amountStr) < minStakeAmount) {
                    alert(`质押金额不能小于 ${minStakeAmount} USDT`);
                    throw new Error("金额太小");
                }
            } catch (e) {
                console.log("最小质押金额检查失败，继续...");
            }

            // 1. 检查并授权 USDT
            currentBtn.textContent = "检查授权...";
            const allowance = await usdtContract.allowance(userAddress, CONFIG.STAKING);
            if (allowance < amountWei) {
                currentBtn.textContent = "正在授权 USDT...";
                const txApprove = await usdtContract.approve(CONFIG.STAKING, ethers.MaxUint256); 
                await txApprove.wait();
            }

            // 2. 发起质押
            currentBtn.textContent = "正在质押...";
            const txStake = await stakingContract.stake(
                amountWei, 
                0, 
                stakeIndex
            );
            
            await txStake.wait();
            alert(`质押成功！周期：${durationDays}天`);
            refreshData();

        } catch (error) {
            console.error(error);
            if(error.reason) alert("合约错误: " + error.reason);
            else if(error.message.includes("User denied")) alert("用户取消交易");
            else if(error.message.includes("insufficient allowance")) alert("请先授权USDT");
            else alert("质押失败: " + (error.message || error));
        } finally {
            // 恢复所有按钮
            buttons.forEach((btn, index) => {
                btn.disabled = false;
                btn.textContent = originalTexts[index];
            });
        }
    }

    // 5. 赎回逻辑
    async function handleUnstake(index) {
        if (!userAddress) return;
        
        const btn = document.getElementById(`unstake-btn-${index}`);
        if(btn) {
            btn.disabled = true;
            btn.innerText = "处理中...";
        }

        try {
            const tx = await stakingContract.unstake(index);
            console.log("Transaction sent:", tx.hash);
            
            await tx.wait();
            alert("赎回成功！");
            refreshData();

        } catch (error) {
            console.error(error);
            if(btn) {
                btn.disabled = false;
                btn.innerText = "赎回";
            }
            
            if(error.reason) alert("合约错误: " + error.reason);
            else if(error.message.includes("User denied")) alert("用户取消交易");
            else alert("赎回失败: " + (error.message || error));
        }
    }

    // 6. 刷新总质押数据
    async function refreshAllStakeData() {
        if (!stakingContract) {
            alert("请先连接钱包");
            return;
        }
        
        const btn = document.querySelector('button[onclick="refreshAllStakeData()"]');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "加载中...";
        
        try {
            // 清空现有数据
            allStakeData = [];
            
            // 获取合约总质押金额
            const totalStaked = await stakingContract.totalSupply();
            document.getElementById('totalStaked').innerText = formatAmountTwoDecimals(totalStaked);
            
            // 模拟获取用户质押记录
            // 注意：实际应用中应该从事件日志中获取所有用户的质押记录
            // 这里我们使用示例数据和当前用户的数据来模拟
            
            // 1. 先获取当前用户的质押记录
            await addUserStakeRecords(userAddress);
            
            // 2. 添加示例用户的质押记录
            for (const address of CONFIG.SAMPLE_USER_ADDRESSES) {
                await addUserStakeRecords(address);
            }
            
            // 3. 计算统计信息
            calculateTotalStats();
            
            // 4. 渲染总质押列表
            renderAllStakeList();
            
            // 5. 更新分页控件
            updatePagination();
            
            btn.innerText = "刷新成功";
            setTimeout(() => {
                btn.innerText = originalText;
                btn.disabled = false;
            }, 1500);
            
        } catch (error) {
            console.error("获取总质押数据失败:", error);
            btn.innerText = "刷新失败";
            btn.disabled = false;
        }
    }
    
    // 添加用户质押记录
    async function addUserStakeRecords(address) {
        try {
            // 获取用户的质押数量
            const stakeCount = await stakingContract.stakeCount(address);
            
            // 遍历每个质押记录
            for (let i = 0; i < Number(stakeCount); i++) {
                try {
                    const record = await stakingContract.userStakeRecord(address, i);
                    
                    const stakeData = {
                        userAddress: address,
                        stakeId: i,
                        amount: record[1],
                        stakeTime: Number(record[0]),
                        isActive: record[2],
                        stakeIndex: Number(record[3])
                    };
                    
                    allStakeData.push(stakeData);
                } catch (err) {
                    console.error(`获取用户 ${address} 的第 ${i} 条记录失败:`, err);
                }
            }
        } catch (error) {
            console.error(`获取用户 ${address} 的质押记录失败:`, error);
        }
    }
    
    // 计算总质押统计信息
    function calculateTotalStats() {
        if (allStakeData.length === 0) {
            document.getElementById('totalUsers').textContent = '0';
            document.getElementById('activeStakes').textContent = '0';
            document.getElementById('avgStakeAmount').textContent = '0.0000';
            document.getElementById('totalStakeCount').textContent = '0';
            return;
        }
        
        // 计算唯一用户数
        const uniqueUsers = new Set();
        allStakeData.forEach(record => uniqueUsers.add(record.userAddress));
        document.getElementById('totalUsers').textContent = uniqueUsers.size;
        
        // 计算活跃质押数量（未提取的）
        const activeStakes = allStakeData.filter(record => !record.isActive).length;
        document.getElementById('activeStakes').textContent = activeStakes;
        
        // 计算总质押次数
        document.getElementById('totalStakeCount').textContent = allStakeData.length;
        
        // 计算平均质押金额
        const totalAmount = allStakeData.reduce((sum, record) => {
            return sum + parseFloat(ethers.formatUnits(record.amount, 18));
        }, 0);
        
        const avgAmount = totalAmount / allStakeData.length;
        document.getElementById('avgStakeAmount').textContent = avgAmount.toFixed(2);
    }
    
    // 渲染总质押列表
    function renderAllStakeList() {
        const tbody = document.getElementById('allStakeListBody');
        
        if (allStakeData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">暂无质押记录</td></tr>';
            return;
        }
        
        // 按质押时间倒序排序
        allStakeData.sort((a, b) => b.stakeTime - a.stakeTime);
        
        // 计算分页
        const startIndex = (currentPage - 1) * CONFIG.TOTAL_STAKE_PAGE_SIZE;
        const endIndex = Math.min(startIndex + CONFIG.TOTAL_STAKE_PAGE_SIZE, allStakeData.length);
        const pageData = allStakeData.slice(startIndex, endIndex);
        
        let html = '';
        
        pageData.forEach((record, index) => {
            const globalIndex = startIndex + index;
            const amount = formatAmountTwoDecimals(record.amount);
            const stakeTimeStr = formatStakeTime(record.stakeTime);
            const durationLabel = STAKE_DURATION_LABELS[record.stakeIndex] || "未知";
            const status = record.isActive ? "已提取" : "质押中";
            const statusClass = record.isActive ? "text-muted" : "text-success";
            const isCurrentUser = record.userAddress.toLowerCase() === (userAddress || '').toLowerCase();
            
            html += `
                <tr>
                    <td>${globalIndex + 1}</td>
                    <td>
                        <span class="address-short">${shortenAddress(record.userAddress)}</span>
                        ${isCurrentUser ? '<span class="badge bg-info ms-2">我</span>' : ''}
                    </td>
                    <td>${amount}</td>
                    <td><span class="badge-duration">${durationLabel}</span></td>
                    <td class="stake-time-cell">${stakeTimeStr}</td>
                    <td class="status-cell"><span class="${statusClass}">${status}</span></td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
    }
    
    // 更新分页控件
    function updatePagination() {
        totalPages = Math.ceil(allStakeData.length / CONFIG.TOTAL_STAKE_PAGE_SIZE);
        
        document.getElementById('currentPage').textContent = currentPage;
        document.getElementById('totalPages').textContent = totalPages;
        
        document.getElementById('prevPageBtn').disabled = currentPage <= 1;
        document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
    }
    
    // 上一页
    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            renderAllStakeList();
            updatePagination();
        }
    }
    
    // 下一页
    function nextPage() {
        if (currentPage < totalPages) {
            currentPage++;
            renderAllStakeList();
            updatePagination();
        }
    }
    
    // 自动刷新功能
    function startAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
        
        autoRefreshInterval = setInterval(async () => {
            if (userAddress) {
                await refreshData();
                // 如果当前在查看总质押记录，也刷新总质押数据
                const activeTab = document.querySelector('#stakeTab .nav-link.active');
                if (activeTab && activeTab.id === 'all-stake-tab') {
                    await refreshAllStakeData();
                }
            }
        }, 30000); // 每30秒刷新一次
    }

    function toggleAutoRefresh() {
        const btn = document.getElementById('autoRefreshBtn');
        
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
            btn.textContent = "自动刷新: 关闭";
            btn.classList.remove('btn-info');
            btn.classList.add('btn-outline-info');
        } else {
            startAutoRefresh();
            btn.textContent = "自动刷新: 开启";
            btn.classList.remove('btn-outline-info');
            btn.classList.add('btn-info');
        }
    }

    // 页面卸载时清理定时器
    window.addEventListener('beforeunload', () => {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
        Object.keys(countdownTimers).forEach(id => {
            clearInterval(countdownTimers[id]);
        });
    });

    // 初始连接钱包
    window.addEventListener('load', () => {
        if (typeof window.ethereum !== 'undefined') {
            // 检查是否已连接
            window.ethereum.request({ method: 'eth_accounts' })
                .then(accounts => {
                    if (accounts.length > 0) {
                        connectWallet();
                    }
                });
        }
        
        // 显示当前合约地址
        document.getElementById('stakingContractAddress').textContent = CONFIG.STAKING;
        document.getElementById('lpContractAddress').textContent = CONFIG.PAIR;
    });
</script>

<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"65a056423e6e441d8a24f89a02024cd8","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>
