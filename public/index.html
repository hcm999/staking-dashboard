<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GANAè´¨æŠ¼æ•°æ®ç›‘æ§å¹³å°</title>
    <!-- å¼•å…¥ Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ Ethers.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        /* è¿™é‡Œæ”¾ä¹‹å‰çš„CSSæ ·å¼ï¼Œä¸ºäº†èŠ‚çœç©ºé—´æˆ‘å°±ä¸é‡å¤äº† */
        /* è¯·å¤åˆ¶ä¹‹å‰æä¾›çš„å®Œæ•´CSSæ ·å¼ */
        body { 
            background-color: #0f172a; 
            color: #e2e8f0; 
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
        }
        /* ... å…¶ä»–æ ·å¼ä¿æŒä¸å˜ ... */
    </style>
</head>
<body>
    <!-- HTMLç»“æ„ä¿æŒä¸å˜ -->
    <div class="container-fluid">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ” GANA è´¨æŠ¼æ•°æ®ç›‘æ§å¹³å°</h1>
            <div class="subtitle">æ‰¹é‡æŸ¥è¯¢é’±åŒ…è´¨æŠ¼è®°å½• Â· å®æ—¶æ•°æ®ç»Ÿè®¡</div>
            <div class="contract-address" id="stakingContractAddress">0x72212F35aC448FE7763aA1BFdb360193Fa098E52</div>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <!-- æ€»è´¨æŠ¼é‡‘é¢ -->
            <div class="stat-card">
                <div class="stat-title">ğŸ“Š æ€»è´¨æŠ¼é‡‘é¢</div>
                <div class="stat-value" id="totalStaked">0.00</div>
                <div class="stat-sub">USDT</div>
            </div>
            <!-- 1å¤©æ±  -->
            <div class="stat-card">
                <div class="stat-title">ğŸ“ˆ 1å¤©æ± æ€»è´¨æŠ¼</div>
                <div class="stat-value" id="totalStaked1d">0.00</div>
                <div class="stat-sub">USDT <span class="stats-badge" id="count1d">0åœ°å€</span></div>
            </div>
            <!-- 15å¤©æ±  -->
            <div class="stat-card">
                <div class="stat-title">ğŸ“Š 15å¤©æ± æ€»è´¨æŠ¼</div>
                <div class="stat-value" id="totalStaked15d">0.00</div>
                <div class="stat-sub">USDT <span class="stats-badge" id="count15d">0åœ°å€</span></div>
            </div>
            <!-- 30å¤©æ±  -->
            <div class="stat-card">
                <div class="stat-title">ğŸ“ˆ 30å¤©æ± æ€»è´¨æŠ¼</div>
                <div class="stat-value" id="totalStaked30d">0.00</div>
                <div class="stat-sub">USDT <span class="stats-badge" id="count30d">0åœ°å€</span></div>
            </div>
        </div>

        <!-- æœªæ¥èµå›ç»Ÿè®¡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-title">â³ æœªæ¥2å¤©å¯èµå›</div>
                <div class="stat-value" id="unlock2d">0.00</div>
                <div class="stat-sub">USDT</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ğŸ“… æœªæ¥7å¤©å¯èµå›</div>
                <div class="stat-value" id="unlock7d">0.00</div>
                <div class="stat-sub">USDT</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ğŸ“Š æœªæ¥15å¤©å¯èµå›</div>
                <div class="stat-value" id="unlock15d">0.00</div>
                <div class="stat-sub">USDT</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ğŸ‘¥ æŸ¥è¯¢åœ°å€æ•°</div>
                <div class="stat-value" id="totalAddresses">0</div>
                <div class="stat-sub">/ æœ€å¤§1000</div>
            </div>
        </div>

        <!-- åœ°å€è¾“å…¥åŒºåŸŸ -->
        <div class="address-input-area">
            <h5>ğŸ“‹ æ‰¹é‡æŸ¥è¯¢é’±åŒ…åœ°å€</h5>
            <textarea id="addressList" class="address-textarea" placeholder="è¯·è¾“å…¥é’±åŒ…åœ°å€ï¼Œæ¯è¡Œä¸€ä¸ª">0x72212F35aC448FE7763aA1BFdb360193Fa098E52</textarea>
            
            <div class="example-tags">
                <span class="example-tag" onclick="addExampleAddress('0x72212F35aC448FE7763aA1BFdb360193Fa098E52')">â• æ·»åŠ åˆçº¦åœ°å€</span>
                <span class="example-tag" onclick="addExampleAddress('0x55d398326f99059fF775485246999027B3197955')">â• æ·»åŠ USDTåœ°å€</span>
                <span class="example-tag" onclick="clearAddresses()">ğŸ—‘ï¸ æ¸…ç©º</span>
            </div>
            
            <button class="btn-query" onclick="batchQueryAddresses()" id="queryBtn">
                <span id="queryText">ğŸ” å¼€å§‹æ‰¹é‡æŸ¥è¯¢</span>
            </button>
            
            <!-- è¿›åº¦æ¡ -->
            <div id="progressContainer" style="display: none;" class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                </div>
                <div class="loading-text" id="progressText">æ­£åœ¨æŸ¥è¯¢...</div>
            </div>
        </div>

        <!-- ç»“æœè¡¨æ ¼ -->
        <div class="table-container">
            <div class="d-flex justify-content-between">
                <h5>ğŸ“Š æŸ¥è¯¢ç»“æœ <span id="resultCount" class="stats-badge">0æ¡è®°å½•</span></h5>
                <button class="btn-export" onclick="exportToCSV()">ğŸ“¥ å¯¼å‡ºCSV</button>
            </div>
            
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>é’±åŒ…åœ°å€</th>
                            <th>é‡‘é¢</th>
                            <th>å‘¨æœŸ</th>
                            <th>è´¨æŠ¼æ—¶é—´</th>
                            <th>è§£é”æ—¶é—´</th>
                            <th>å‰©ä½™æ—¶é—´</th>
                            <th>çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody id="resultTableBody">
                        <tr><td colspan="8" class="text-center">è¯·è¾“å…¥åœ°å€å¹¶æŸ¥è¯¢</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ================= é…ç½® =================
        const CONFIG = {
            STAKING: "0x72212F35aC448FE7763aA1BFdb360193Fa098E52",
            MAX_ADDRESSES: 1000,
            BATCH_SIZE: 20
        };
        
        const STAKE_DURATIONS = {0: 86400, 1: 1296000, 2: 2592000};
        const STAKE_DURATION_LABELS = {0: "1å¤©", 1: "15å¤©", 2: "30å¤©"};
        const STAKE_DURATION_CLASS = {0: "badge-1d", 1: "badge-15d", 2: "badge-30d"};

        // ABI
        const ABI_STAKING = [/* è¿™é‡Œæ”¾å®Œæ•´çš„ABIï¼Œä¸ºäº†èŠ‚çœç©ºé—´çœç•¥ï¼Œå®é™…ä½¿ç”¨æ—¶è¦æ”¾å®Œæ•´ */];

        // å…¨å±€å˜é‡
        let stakingContract;
        let isQuerying = false;
        let queryResults = [];
        let stats = {
            totalStaked: 0, totalStaked1d: 0, totalStaked15d: 0, totalStaked30d: 0,
            count1d: 0, count15d: 0, count30d: 0,
            unlock2d: 0, unlock7d: 0, unlock15d: 0
        };

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            const provider = new ethers.JsonRpcProvider('/api/proxy');
            stakingContract = new ethers.Contract(CONFIG.STAKING, ABI_STAKING, provider);
            document.getElementById('stakingContractAddress').innerText = CONFIG.STAKING;
        });

        // åœ°å€è¾…åŠ©å‡½æ•°
        function addExampleAddress(addr) {
            const ta = document.getElementById('addressList');
            ta.value = ta.value.trim() + '\n' + addr;
        }

        function clearAddresses() {
            document.getElementById('addressList').value = '';
        }

        // æ ¼å¼åŒ–å‡½æ•°
        function formatAmount(wei) {
            return parseFloat(ethers.formatUnits(wei, 18)).toFixed(2);
        }

        function formatTimeRemaining(seconds) {
            if (seconds <= 0) return "å·²è§£é”";
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            if (days > 0) return `${days}å¤©${hours}å°æ—¶`;
            return `${hours}å°æ—¶${Math.floor((seconds % 3600) / 60)}åˆ†`;
        }

        function formatStakeTime(ts) {
            const d = new Date(ts * 1000);
            const now = new Date();
            const diff = Math.floor((now - d) / 86400000);
            const date = diff === 0 ? 'ä»Šå¤©' : diff === 1 ? 'æ˜¨å¤©' : `${d.getMonth()+1}/${d.getDate()}`;
            const time = d.toTimeString().slice(0, 8);
            return {date, time};
        }

        function shortenAddress(addr) {
            return addr.slice(0, 6) + '...' + addr.slice(-4);
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            document.getElementById('totalStaked').innerText = stats.totalStaked.toFixed(2);
            document.getElementById('totalStaked1d').innerText = stats.totalStaked1d.toFixed(2);
            document.getElementById('totalStaked15d').innerText = stats.totalStaked15d.toFixed(2);
            document.getElementById('totalStaked30d').innerText = stats.totalStaked30d.toFixed(2);
            document.getElementById('unlock2d').innerText = stats.unlock2d.toFixed(2);
            document.getElementById('unlock7d').innerText = stats.unlock7d.toFixed(2);
            document.getElementById('unlock15d').innerText = stats.unlock15d.toFixed(2);
            document.getElementById('count1d').innerText = stats.count1d + 'åœ°å€';
            document.getElementById('count15d').innerText = stats.count15d + 'åœ°å€';
            document.getElementById('count30d').innerText = stats.count30d + 'åœ°å€';
            document.getElementById('totalAddresses').innerText = queryResults.length;
            document.getElementById('resultCount').innerText = queryResults.length + 'æ¡è®°å½•';
        }

        // æ‰¹é‡æŸ¥è¯¢
        async function batchQueryAddresses() {
            if (!stakingContract) return alert("è¯·ç­‰å¾…åˆçº¦åˆå§‹åŒ–");
            if (isQuerying) return;

            const addresses = document.getElementById('addressList').value.split('\n')
                .map(l => l.trim()).filter(l => l.startsWith('0x') && l.length === 42);
            
            if (!addresses.length) return alert("æ²¡æœ‰æœ‰æ•ˆåœ°å€");
            if (addresses.length > CONFIG.MAX_ADDRESSES) 
                return alert(`æœ€å¤š${CONFIG.MAX_ADDRESSES}ä¸ªåœ°å€`);

            isQuerying = true;
            queryResults = [];
            stats = {totalStaked:0, totalStaked1d:0, totalStaked15d:0, totalStaked30d:0,
                     count1d:0, count15d:0, count30d:0, unlock2d:0, unlock7d:0, unlock15d:0};

            document.getElementById('queryText').innerHTML = 'â³ æŸ¥è¯¢ä¸­...';
            document.getElementById('queryBtn').disabled = true;
            document.getElementById('progressContainer').style.display = 'block';

            const now = Math.floor(Date.now() / 1000);
            const limits = {
                '2d': now + 172800, '7d': now + 604800, '15d': now + 1296000
            };

            let processed = 0;
            for (let i = 0; i < addresses.length; i += CONFIG.BATCH_SIZE) {
                const batch = addresses.slice(i, i + CONFIG.BATCH_SIZE);
                const batchResults = await Promise.all(batch.map(async addr => {
                    try {
                        const count = await stakingContract.stakeCount(addr);
                        const records = [];
                        for (let j = 0; j < Number(count); j++) {
                            const r = await stakingContract.userStakeRecord(addr, j);
                            if (!r[2]) { // æ´»è·ƒ
                                const amount = parseFloat(ethers.formatUnits(r[1], 18));
                                const unlock = Number(r[0]) + STAKE_DURATIONS[Number(r[3])];
                                records.push({
                                    address: addr, amount,
                                    stakeTime: Number(r[0]),
                                    stakeIndex: Number(r[3]),
                                    unlockTime: unlock,
                                    timeRemaining: unlock - now
                                });
                                
                                stats.totalStaked += amount;
                                if (r[3] == 0) { stats.totalStaked1d += amount; stats.count1d++; }
                                else if (r[3] == 1) { stats.totalStaked15d += amount; stats.count15d++; }
                                else { stats.totalStaked30d += amount; stats.count30d++; }
                                
                                if (unlock <= limits['2d']) stats.unlock2d += amount;
                                if (unlock <= limits['7d']) stats.unlock7d += amount;
                                if (unlock <= limits['15d']) stats.unlock15d += amount;
                            }
                        }
                        return records;
                    } catch { return []; }
                }));

                batchResults.forEach(r => queryResults.push(...r));
                processed += batch.length;
                document.getElementById('progressFill').style.width = 
                    Math.round(processed / addresses.length * 100) + '%';
                document.getElementById('progressText').innerHTML = 
                    `æŸ¥è¯¢ä¸­ ${processed}/${addresses.length} (æ‰¾åˆ° ${queryResults.length} æ¡)`;
                updateStats();
                await new Promise(r => setTimeout(r, 50));
            }

            queryResults.sort((a,b) => b.stakeTime - a.stakeTime);
            
            // æ¸²æŸ“è¡¨æ ¼
            const tbody = document.getElementById('resultTableBody');
            tbody.innerHTML = queryResults.map((r, i) => {
                const t = formatStakeTime(r.stakeTime);
                const u = formatStakeTime(r.unlockTime);
                const status = r.timeRemaining <= 0 ? 'å¯èµå›' : 'é”ä»“ä¸­';
                const cls = r.timeRemaining <= 0 ? 'status-unlocked' : 'status-locked';
                return `<tr>
                    <td>${i+1}</td>
                    <td class="address-cell" title="${r.address}">${shortenAddress(r.address)}</td>
                    <td class="amount-cell">${r.amount.toFixed(2)}</td>
                    <td><span class="badge-duration ${STAKE_DURATION_CLASS[r.stakeIndex]}">${STAKE_DURATION_LABELS[r.stakeIndex]}</span></td>
                    <td><div class="time-two-lines"><span class="time-date">${t.date}</span><span class="time-clock">${t.time}</span></div></td>
                    <td><div class="time-two-lines"><span class="time-date">${u.date}</span><span class="time-clock">${u.time}</span></div></td>
                    <td class="${cls}">${r.timeRemaining <= 0 ? 'å·²è§£é”' : formatTimeRemaining(r.timeRemaining)}</td>
                    <td class="${cls}">${status}</td>
                </tr>`;
            }).join('');

            updateStats();
            document.getElementById('queryText').innerHTML = 'âœ… æŸ¥è¯¢å®Œæˆ';
            setTimeout(() => {
                document.getElementById('queryText').innerHTML = 'ğŸ” å¼€å§‹æ‰¹é‡æŸ¥è¯¢';
                document.getElementById('queryBtn').disabled = false;
                document.getElementById('progressContainer').style.display = 'none';
            }, 2000);
            isQuerying = false;
        }

        // å¯¼å‡ºCSV
        function exportToCSV() {
            if (!queryResults.length) return alert("æ²¡æœ‰æ•°æ®");
            const csv = ["åºå·,åœ°å€,é‡‘é¢,å‘¨æœŸ,è´¨æŠ¼æ—¶é—´,è§£é”æ—¶é—´,å‰©ä½™æ—¶é—´,çŠ¶æ€"];
            queryResults.forEach((r,i) => {
                const t = new Date(r.stakeTime*1000).toLocaleString();
                const u = new Date(r.unlockTime*1000).toLocaleString();
                const status = r.timeRemaining <= 0 ? 'å¯èµå›' : 'é”ä»“ä¸­';
                const remain = r.timeRemaining <= 0 ? 'å·²è§£é”' : formatTimeRemaining(r.timeRemaining);
                csv.push(`${i+1},${r.address},${r.amount.toFixed(2)},${STAKE_DURATION_LABELS[r.stakeIndex]},${t},${u},${remain},${status}`);
            });
            
            const blob = new Blob(["\uFEFF" + csv.join('\n')], {type: 'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `è´¨æŠ¼æ•°æ®_${new Date().toLocaleDateString()}.csv`;
            a.click();
        }
    </script>
</body>
</html>
